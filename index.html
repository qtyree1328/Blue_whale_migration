<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blue Whale Smooth Morphing Heatmap</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

  <link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0-beta.1/mapbox-gl.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
    }

    /* Description block above the map */
    #description {
      max-width: 900px;
      margin: 16px auto 8px auto;
      padding: 0 16px;
      color: #ffffff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      text-align: left;
      box-sizing: border-box;
    }
    #description h2 {
      margin: 0 0 6px 0;
      font-size: 20px;
      font-weight: 700;
    }

    /* Map container – captions & month sit INSIDE this box */
    #map {
      position: relative;
      width: 100%;
      height: 85vh;  /* nice tall embed for Squarespace */
    }

    #controls {
      position:absolute; top:10px; left:10px; z-index:4;
      background:rgba(0,0,0,0.7); color:#fff;
      padding:10px 14px; border-radius:6px;
      font-family:system-ui; font-size:13px;
    }
    #monthSlider { width:200px; }
    #playPause { margin-top:6px; padding:4px 10px; font-size:12px; }

    /* Dataset selector (top-right) */
    #modeSelector {
      position:absolute; top:10px; right:10px; z-index:4;
      background:rgba(0,0,0,0.7); color:#fff;
      padding:8px 10px; border-radius:6px;
      font-family:system-ui; font-size:13px;
    }
    #mapMode {
      margin-left:4px;
      font-size:13px;
    }

    /* Title overlay at top INSIDE map */
    #captionBar {
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      z-index:3;
      background:#000000;          /* fully opaque black */
      color:#ffffff;
      padding:12px 20px;           /* larger box */
      border-radius:8px;
      font-family:system-ui;
      font-size:22px;              /* larger text */
      font-weight:700;
      letter-spacing:0.4px;
      pointer-events:none;
      max-width:95%;
      text-align:center;
      box-sizing:border-box;
    }

    /* Month label at bottom INSIDE map */
    #monthBottom {
      position:absolute;
      bottom:12px;
      left:50%;
      transform:translateX(-50%);
      z-index:3;
      color:#ffffff;
      font-family:system-ui;
      font-size:24px;
      font-weight:700;
      text-shadow:0 0 8px rgba(0,0,0,0.85);
      pointer-events:none;
      letter-spacing:1px;
      padding:4px 10px;
      background:rgba(0,0,0,0.35);
      border-radius:6px;
      max-width:90%;
      text-align:center;
      box-sizing:border-box;
    }
  </style>
</head>
<body>

<div id="description">
  <h2>Blue Whale Migration using MapBox</h2>
  <p>
    This map was created with MapBox, using data collected by
    <a href="https://www.researchgate.net/publication/228328857_Behavioural_estimation_of_blue_whale_movements_in_the_Northeast_Pacific_from_state-space_model_analysis_of_satellite_tracks"
       target="_blank" rel="noopener noreferrer">Bailey et al. (2009)</a>.
    Data was accessed through Movebank. Use the selection tool to choose between
    visualizing one year of data and the complete dataset.
  </p>
</div>

<div id="map">
  <div id="controls">
    Month: <span id="monthLabel">January</span><br>
    <input id="monthSlider" type="range" min="1" max="12" step="1" value="1"><br>
    <button id="playPause">Play</button>
  </div>

  <!-- Dataset selector -->
  <div id="modeSelector">
    Dataset:
    <select id="mapMode">
      <option value="2008" selected>2008 only</option>
      <option value="full">1993–2009</option>
    </select>
  </div>

  <div id="captionBar">
    Blue whale observations in 2008 in California
  </div>

  <div id="monthBottom">January</div>
</div>

<script>
mapboxgl.accessToken =
'pk.eyJ1IjoicXR5cmVlIiwiYSI6ImNtaHl5eHNmeDBoY3oybXEwNTIxNGgxYmsifQ.VqoAKKHQxQX-lNNPwVKHmw';

const monthNames = [
  'January','February','March','April','May','June',
  'July','August','September','October','November','December'
];

// Two map modes: 2008-only and full record
const MODES = {
  '2008': {
    sourceId: 'whales-2008',
    layerId: 'hm-2008',
    url: 'mapbox://qtyree.5ay48rvk',
    sourceLayer: 'Blue_whales_2008-cb2xp2',
    caption: 'Blue whale observations in 2008 in California'
  },
  'full': {
    sourceId: 'whales-full',
    layerId: 'hm-full',
    url: 'mapbox://qtyree.bv54ok7h',
    sourceLayer: 'Blue_whales_Eastern_North_Pac-bhcw4q',
    caption: 'Blue whale observations (1993–2009) in California'
  }
};

let currentMode = '2008';

const morphDuration = 1000;  // ms per morph (blurring up during change)
const settleDuration = 1000; // ms per settle (deblurring while static)
const baseOpacity = 0.85;
const extraBlur = 0.5;       // max additional radius factor

let monthA = 1;              // current month
let monthB = 2;              // next month
let phase = 0;               // 0..1 animation phase
let state = 'morphing';      // 'morphing' or 'settling'
let animTimer = null;
let startTime = null;
let isPlaying = true;

// Zoomed out & centered on US
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/standard',
  config: { basemap:{ theme:'monochrome', lightPreset:'night' }},
  center: [-100, 37],
  zoom: 2
});

function activeConfig() {
  return MODES[currentMode];
}

function setFilter() {
  const cfg = activeConfig();
  map.setFilter(cfg.layerId, ['in', ['get', 'month'], ['literal', [monthA, monthB]]]);
}

function setWeight(phase) {
  const cfg = activeConfig();
  const weightExpr = [
    'case',
    ['==', ['get', 'month'], monthA], 1 - phase,
    ['==', ['get', 'month'], monthB], phase,
    0
  ];
  map.setPaintProperty(cfg.layerId, 'heatmap-weight', weightExpr);
}

function applyRadius(phase) {
  const cfg = activeConfig();
  const blurFactor = Math.sin(phase * Math.PI / 2) * extraBlur;
  const factor = 1 + blurFactor;
  const radiusExpr = [
    'interpolate', ['linear'], ['zoom'],
    0, 2 * factor,
    3, 10 * factor,
    6, 20 * factor,
    9, 35 * factor
  ];
  map.setPaintProperty(cfg.layerId, 'heatmap-radius', radiusExpr);
}

function updateCaption() {
  document.getElementById('captionBar').textContent = activeConfig().caption;
}

function updateLabelSlider() {
  const label = monthNames[monthA - 1];
  document.getElementById('monthSlider').value = String(monthA);
  document.getElementById('monthLabel').textContent = label;
  const mb = document.getElementById('monthBottom');
  if (mb) mb.textContent = label;
}

function stepAnimation(timestamp) {
  if (startTime === null) startTime = timestamp;
  const elapsed = timestamp - startTime;
  const duration = (state === 'morphing') ? morphDuration : settleDuration;
  phase = elapsed / duration;

  if (state === 'morphing') {
    if (phase < 1) {
      setWeight(phase);
      applyRadius(phase);
    } else {
      phase = 1;
      setWeight(phase);
      applyRadius(phase);

      // Rollover to next month
      monthA = monthB;
      monthB = (monthB % 12) + 1;
      setFilter();
      updateLabelSlider();

      // Switch to settling (deblur while static on new month)
      state = 'settling';
      startTime = timestamp;
      phase = 1;
    }
  } else if (state === 'settling') {
    phase = 1 - (elapsed / settleDuration);
    if (phase > 0) {
      setWeight(0); // fixed for current month
      applyRadius(phase);
    } else {
      phase = 0;
      setWeight(0);
      applyRadius(phase);

      // Back to morphing for next cycle
      state = 'morphing';
      startTime = null;
    }
  }

  if ((state === 'morphing' && phase < 1) || (state === 'settling' && phase > 0)) {
    animTimer = requestAnimationFrame(stepAnimation);
  } else if (isPlaying) {
    animTimer = requestAnimationFrame(stepAnimation);
  }
}

function startAnimation() {
  if (isPlaying) return;
  isPlaying = true;
  document.getElementById('playPause').textContent = 'Pause';
  state = 'morphing';
  startTime = null;
  animTimer = requestAnimationFrame(stepAnimation);
}

function stopAnimation() {
  isPlaying = false;
  document.getElementById('playPause').textContent = 'Play';
  if (animTimer) {
    cancelAnimationFrame(animTimer);
    animTimer = null;
  }
  startTime = null;
}

map.on('load', () => {

  // Shared paint for both layers
  const basePaint = {
    'heatmap-weight': 1,
    'heatmap-intensity': [
      'interpolate',['linear'],['zoom'],
      0,0.6, 5,1.2, 9,2.0
    ],
    'heatmap-color': [
      'interpolate',['linear'],['heatmap-density'],
      0.0,'rgba(0,0,0,0)',
      0.2,'rgba(37,52,148,0.7)',
      0.4,'rgba(33,144,140,0.75)',
      0.6,'rgba(253,174,97,0.8)',
      0.8,'rgba(215,48,39,0.85)',
      1.0,'rgba(158,1,66,0.9)'
    ],
    'heatmap-radius': [
      'interpolate',['linear'],['zoom'],
      0,2, 3,10, 6,20, 9,35
    ],
    'heatmap-opacity': baseOpacity,
    'heatmap-opacity-transition': { duration: 0, delay: 0 },
    'heatmap-radius-transition': { duration: 0, delay: 0 },
    'heatmap-weight-transition': { duration: 0, delay: 0 }
  };

  // Add both sources & layers; control visibility with layout
  Object.keys(MODES).forEach(modeKey => {
    const cfg = MODES[modeKey];

    map.addSource(cfg.sourceId, {
      type: 'vector',
      url: cfg.url
    });

    map.addLayer({
      id: cfg.layerId,
      type: 'heatmap',
      source: cfg.sourceId,
      'source-layer': cfg.sourceLayer,
      maxzoom: 9,
      paint: basePaint,
      layout: {
        'visibility': (modeKey === currentMode) ? 'visible' : 'none'
      },
      slot: 'top'
    });
  });

  // initial state
  setFilter();
  setWeight(0);
  applyRadius(0);
  updateLabelSlider();
  updateCaption();

  // Slider
  const slider = document.getElementById('monthSlider');
  slider.addEventListener('input', () => {
    stopAnimation();
    monthA = parseInt(slider.value, 10);
    monthB = (monthA % 12) + 1;
    setFilter();
    setWeight(0);
    applyRadius(0);
    updateLabelSlider();
  });

  // Play/pause
  document.getElementById('playPause').addEventListener('click', () => {
    if (isPlaying) {
      stopAnimation();
    } else {
      startAnimation();
    }
  });

  // Mode selector (switch between 2008 and full record)
  document.getElementById('mapMode').addEventListener('change', (e) => {
    const newMode = e.target.value;
    if (newMode === currentMode) return;

    // Hide old layer, show new one
    map.setLayoutProperty(MODES[currentMode].layerId, 'visibility', 'none');
    currentMode = newMode;
    map.setLayoutProperty(MODES[currentMode].layerId, 'visibility', 'visible');

    // Re-apply filters/weights/radius to the new active layer
    setFilter();
    setWeight(0);
    applyRadius(0);
    updateCaption();
    updateLabelSlider();

    // If it was playing, resume animation from new mode
    if (isPlaying) {
      state = 'morphing';
      startTime = null;
      if (!animTimer) {
        animTimer = requestAnimationFrame(stepAnimation);
      }
    }
  });

  // Auto-start animation if you want it playing by default:
  animTimer = requestAnimationFrame(stepAnimation);
});
</script>

</body>
</html>
